<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade View 2025 XAUUSD.m</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #ffffff;
    height: 100%;
    font-family: Arial, sans-serif;
  }
  #chart {
    width: 100%;
    height: 100%;
  }
</style>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<script type="module">
  // ---------------- Firebase sozlamalari ----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB1_XCbC777hKwxlilhMeq5Hpty1dvDT1I",
    authDomain: "giper-8fd92.firebaseapp.com",
    databaseURL: "https://giper-8fd92-default-rtdb.firebaseio.com",
    projectId: "giper-8fd92",
    storageBucket: "giper-8fd92.firebasestorage.app",
    messagingSenderId: "485740337398",
    appId: "1:485740337398:web:ab901fd4f28219ea5834d7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------------- Chart sozlamalari ----------------
  const chart = LightweightCharts.createChart(document.getElementById("chart"), {
    layout: {
      background: { color: "#ffffff" },
      textColor: "#333",
    },
    grid: {
      vertLines: { color: "rgba(230, 230, 230, 1)" },
      horzLines: { color: "rgba(230, 230, 230, 1)" },
    },
    rightPriceScale: {
      borderColor: "rgba(180, 180, 180, 1)",
    },
    timeScale: {
      borderColor: "rgba(180, 180, 180, 1)",
      timeVisible: true,
      secondsVisible: false,
    },
  });

  const candleSeries = chart.addCandlestickSeries({
    upColor: "#26a69a",
    borderUpColor: "#26a69a",
    wickUpColor: "#26a69a",
    downColor: "#ef5350",
    borderDownColor: "#ef5350",
    wickDownColor: "#ef5350",
  });

  // ---------------- Demo boshlang‘ich ma’lumotlar ----------------
  let candles = [];
  let time = Math.floor(Date.now() / 1000) - 60 * 300; // ~300 ta orqa sham (5 soat)
  let price = 100;

  for (let i = 0; i < 300; i++) { // ko‘proq tarix ko‘rsatish uchun
    const open = price;
    const close = open + (Math.random() - 0.5) * 5;
    const high = Math.max(open, close) + Math.random() * 2;
    const low = Math.min(open, close) - Math.random() * 2;
    candles.push({ time, open, high, low, close });
    time += 60;
    price = close;
  }
  candleSeries.setData(candles);

  // ---------------- Firebase signalni o‘qish ----------------
  let tradeSignal = "buy"; // default

  const tradeRef = ref(db, "trade/trade");
  onValue(tradeRef, (snapshot) => {
    const val = snapshot.val();
    if (val) {
      tradeSignal = val.toLowerCase();
      console.log("Firebase signal:", tradeSignal);
    }
  });

  // ---------------- Candle vaqti bilan real harakat ----------------
  let currentCandle = candles[candles.length - 1];
  let lastCandleStart = Date.now();
  const CANDLE_DURATION = 60000; // 1 minut (60,000 ms)

  setInterval(() => {
    const now = Date.now();

    // Agar 1 minut o'tgan bo‘lsa — yangi sham ochamiz
    if (now - lastCandleStart >= CANDLE_DURATION) {
      const open = currentCandle.close;
      const close = open; // yangi sham boshlanishida close = open
      const high = open;
      const low = open;

      const newCandle = { time, open, high, low, close };
      time += 60;
      candles.push(newCandle);

      // Juda eski shamlarni olib tashlash (masalan, 500 dan oshsa)
      if (candles.length > 500) candles.shift();

      currentCandle = newCandle;
      lastCandleStart = now;
    } else {
      // Hozirgi shamni yangilash (faqat oxirgisini)
      let close;
      const open = currentCandle.open;

      if (tradeSignal === "buy") {
        close = currentCandle.close + Math.random() * 0.2;
      } else if (tradeSignal === "sell") {
        close = currentCandle.close - Math.random() * 0.2;
      } else {
        close = currentCandle.close + (Math.random() - 0.5) * 0.1;
      }

      const high = Math.max(currentCandle.high, close);
      const low = Math.min(currentCandle.low, close);

      currentCandle.close = close;
      currentCandle.high = high;
      currentCandle.low = low;

      candles[candles.length - 1] = currentCandle;
    }

    candleSeries.setData(candles);
  }, 1000); // har soniya yangilab turish
</script>
</head>
<body>
  <div id="chart"></div>
</body>
</html>
